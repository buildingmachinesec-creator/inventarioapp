from kivymd.app import MDApp
from kivymd.uix.tab import MDTabsBase
from kivymd.uix.boxlayout import MDBoxLayout
from kivymd.uix.button import MDRaisedButton, MDIconButton, MDFillRoundFlatButton
from kivymd.uix.textfield import MDTextField
from kivymd.uix.list import MDList, TwoLineAvatarIconListItem, IconLeftWidget, IconRightWidget
from kivymd.uix.scrollview import MDScrollView
from kivymd.uix.toolbar import MDTopAppBar
from kivymd.uix.tab import MDTabs
from kivy.clock import Clock
from kivy.utils import platform
import sqlite3, socket, json, os, threading
from datetime import datetime

if platform == 'android':
    try:
        from jnius import autoclass
        PythonActivity = autoclass('org.kivy.android.PythonActivity')
        activity = PythonActivity.mActivity
        FOLDER = str(activity.getFilesDir().getAbsolutePath())
    except: FOLDER = "."
else:
    FOLDER = "."

DB = os.path.join(FOLDER, "inventario.db")

def init_db():
    conn = sqlite3.connect(DB)
    c = conn.cursor()
    c.execute("""CREATE TABLE IF NOT EXISTS items(
        id TEXT, categoria TEXT, cantidad INTEGER, fecha TEXT
    )""")
    conn.commit()
    conn.close()

# ---------- UI COMPONENTES ----------
class Tab(MDBoxLayout, MDTabsBase):
    pass

class Panel(MDBoxLayout):
    def __init__(self, categoria, app_instance, **kwargs):
        super().__init__(orientation="vertical", spacing=10, padding=10, **kwargs)
        self.categoria = categoria
        self.app = app_instance

        # Inputs de agregar
        self.id_input = MDTextField(hint_text="ID / Nombre Producto", mode="rectangle")
        self.cant_input = MDTextField(hint_text="Cantidad Inicial", input_filter="int", text="1")
        self.add_widget(self.id_input)
        self.add_widget(self.cant_input)
        
        btn_add = MDFillRoundFlatButton(text="AÑADIR NUEVO", pos_hint={"center_x": .5})
        btn_add.bind(on_release=self.agregar_nuevo)
        self.add_widget(btn_add)

        self.scroll = MDScrollView()
        self.lista = MDList()
        self.scroll.add_widget(self.lista)
        self.add_widget(self.scroll)
        
        Clock.schedule_once(self.refrescar)

    def refrescar(self, *args):
        self.lista.clear_widgets()
        filtro = self.app.root.ids.search_field.text.lower()
        
        conn = sqlite3.connect(DB)
        c = conn.cursor()
        c.execute("SELECT * FROM items WHERE categoria=? AND id LIKE ?", (self.categoria, f"%{filtro}%"))
        items = c.fetchall()
        conn.close()

        for item in items:
            # Item con botones de + y -
            row = TwoLineAvatarIconListItem(
                text=f"{item[0]} (Stock: {item[2]})",
                secondary_text=f"Agregado el: {item[3]}"
            )
            
            # Icono de categoría
            icon = IconLeftWidget(icon="package-variant")
            row.add_widget(icon)
            
            # Botones de ajuste rápido
            btn_container = MDBoxLayout(adaptive_width=True, spacing="5dp")
            
            btn_plus = MDIconButton(icon="plus-circle", theme_text_color="Custom", text_color=(0,1,0,1))
            btn_plus.bind(on_release=lambda x, i=item: self.modificar_stock(i, 1))
            
            btn_minus = MDIconButton(icon="minus-circle", theme_text_color="Custom", text_color=(1,0,0,1))
            btn_minus.bind(on_release=lambda x, i=item: self.modificar_stock(i, -1))

            row.add_widget(IconRightWidget(icon="plus", on_release=lambda x, i=item: self.modificar_stock(i, 1)))
            # Para simplificar en móvil usamos el click largo o botones simples
            self.lista.add_widget(row)

    def agregar_nuevo(self, *args):
        if not self.id_input.text: return
        fecha = datetime.now().strftime("%d/%m/%Y %H:%M")
        conn = sqlite3.connect(DB)
        c = conn.cursor()
        c.execute("INSERT INTO items VALUES (?,?,?,?)", 
                 (self.id_input.text, self.categoria, int(self.cant_input.text or 0), fecha))
        conn.commit()
        conn.close()
        self.id_input.text = ""
        self.app.refrescar_todo()

    def modificar_stock(self, item, cambio):
        nueva_cant = max(0, item[2] + cambio)
        conn = sqlite3.connect(DB)
        c = conn.cursor()
        c.execute("UPDATE items SET cantidad=? WHERE id=? AND categoria=?", (nueva_cant, item[0], item[1]))
        conn.commit()
        conn.close()
        self.app.refrescar_todo()

class InventarioApp(MDApp):
    def build(self):
        self.theme_cls.primary_palette = "Indigo"
        init_db()
        
        # UI Principal con Buscador Universal
        self.screen = MDBoxLayout(orientation="vertical")
        
        self.toolbar = MDTopAppBar(title="Mi Inventario Pro")
        self.screen.add_widget(self.toolbar)

        # Buscador Universal
        search_layout = MDBoxLayout(padding="10dp", size_hint_y=None, height="80dp")
        self.search_field = MDTextField(
            id="search_field",
            hint_text="Buscador Universal (ID / Nombre)",
            on_text_validate=self.refrescar_todo,
            mode="fill"
        )
        self.search_field.bind(text=self.refrescar_todo)
        search_layout.add_widget(self.search_field)
        self.screen.add_widget(search_layout)

        self.tabs = MDTabs()
        self.tab_list = []
        for nombre in ["Inventario", "Herramientas", "Otros"]:
            tab = Tab(title=nombre)
            panel = Panel(nombre, self)
            tab.add_widget(panel)
            self.tabs.add_widget(tab)
            self.tab_list.append(panel)
        
        self.screen.add_widget(self.tabs)
        return self.screen

    def refrescar_todo(self, *args):
        for panel in self.tab_list:
            panel.refrescar()

if __name__ == "__main__":
    InventarioApp().run()
